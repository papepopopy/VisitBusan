<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/base}">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>main</title>
</head>

<body>
<div class="container mypage" layout:fragment="content">
    <h1>마이페이지</h1>
    <!--<form class="mypage-top-box" th:action="@{/profile/upload}" method="POST" name="myPageForm" enctype="multipart/form-data">-->
    <form class="mypage-top-box">

        <!--프로필 이미지-->
        <div class="profile_img_box">
            <!--기본 이미지-->
            <div th:if="${profileImage.fileName == 'profile_img.jpg'}" >
                <img th:src="@{/images/profileImage/profile_img.jpg}">
            </div>
            <!--업로드 이미지-->
            <div th:if="${profileImage.fileName != 'profile_img.jpg'}" >
                <img th:src="@{/profile/view/{fileName}(fileName=${profileImage.fileName})}" />
            </div>
        </div>

        <div class="pro-content">
            <h2 class="nick-name" th:text="${member.name}">홍길동</h2>
            <p class="email" th:text="${member.email}">test@gmail.com</p>
            <p class="mypage-comant" th:text="${member.profileText}">여유있는 여행자</p>

            <!--프로필 이미지-->
            <!--<diV class="mypage-upload-btn">
                <label for="uploadImgFile">test</label>
                <input type="file" id="uploadImgFile" name="uploadImgFile">
                <button type="submit" onclick="uploadFile();">변경하기</button>
            </div>-->
            <!--이미지 추가 버튼-->
            <!--<div>
                <input type="button" id="addFilesBtn" class="btn btn-secondary addFilesBtn" value="이미지 등록">
            </div>-->

            <div class="mypage-link">
                <div type="button" class="profileBtn blueBtn">내 정보 수정</div>
                <!--<div type="button" class="blueBtn">알림함</div>-->
                <div type="button" class="addFilesBtn blueBtn">이미지 등록</div>
            </div>
        </div>

    </form>

    <ul class="tab-menu nav nav-tabs mypage-link mt-4" id="myTab" role="tablist">
        <li class="nav-item" role="presentation">
            <h3 class="active" id="home-tab" data-bs-toggle="tab" data-bs-target="#home-tab-pane" role="tab" aria-controls="home-tab-pane" aria-selected="false" tabindex="-1">
                나의 리뷰
            </h3>
        </li>
        <li class="nav-item" role="presentation">
            <h3 class="" id="profile-tab" data-bs-toggle="tab" data-bs-target="#profile-tab-pane" role="tab" aria-controls="profile-tab-pane" aria-selected="true">
                찜한 여행지
            </h3>
        </li>
    </ul>

    <div class="tab-content" id="myTabContent">
        <div class="tab-pane fade active show" id="home-tab-pane" role="tabpanel" aria-labelledby="home-tab" tabindex="0">
            <div class="mypage-bottom-box">
                <div class="rev-inner-list">
                    <div class="row">
                        <div class="col rev-inner-item">
                            <div class="rev-img">
                                <img src="/images/mypage/image1.jpg" alt="이미지">
                            </div>
                            <div class="rev-content">
                                <div class="mypage-tag">#광안리해수욕장</div>
                                <div class="mypage-text">
                                    영화의 도시라는 별명이 있는 부산에서 영화의 전당을 다녀왔습니다.
                                    영화를 좋아한다면 영화의 전당에서 진행하는 영화제 등 행사도 참여해도 좋을 것 같습니다.
                                    평소에도 영화를 볼 수 있고 야외에서 볼 수 있는 공간도 따로 있어서 신기했습니다.
                                    공간자체도 예뻐서 사진 찍으러 오시는 분들도 꽤 많았습니다.
                                    영화를 좋아하신다면 방문해보기 좋은 코스로 추천드립니다!
                                </div>
                                <p class="mypage-date">2024.07.27</p>
                                <div class="mypage-star">
                                    5
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="rev-img">
                                <img src="/images/mypage/image1.jpg" alt="이미지">
                            </div>
                            <div class="rev-content">
                                <div class="mypage-tag">#광안리해수욕장</div>
                                <div class="mypage-text">
                                    영화의 도시라는 별명이 있는 부산에서 영화의 전당을 다녀왔습니다.
                                    영화를 좋아한다면 영화의 전당에서 진행하는 영화제 등 행사도 참여해도 좋을 것 같습니다.
                                    평소에도 영화를 볼 수 있고 야외에서 볼 수 있는 공간도 따로 있어서 신기했습니다.
                                    공간자체도 예뻐서 사진 찍으러 오시는 분들도 꽤 많았습니다.
                                    영화를 좋아하신다면 방문해보기 좋은 코스로 추천드립니다!
                                </div>
                                <p class="mypage-date">2024.07.27</p>
                                <div class="mypage-star">
                                    5
                                </div>
                            </div>
                        </div>
                        <div class="col">
                            <div class="rev-img">
                                <img src="/images/mypage/image1.jpg" alt="이미지">
                            </div>
                            <div class="rev-content">
                                <div class="mypage-tag">#광안리해수욕장</div>
                                <div class="mypage-text">
                                    영화의 도시라는 별명이 있는 부산에서 영화의 전당을 다녀왔습니다.
                                    영화를 좋아한다면 영화의 전당에서 진행하는 영화제 등 행사도 참여해도 좋을 것 같습니다.
                                    평소에도 영화를 볼 수 있고 야외에서 볼 수 있는 공간도 따로 있어서 신기했습니다.
                                    공간자체도 예뻐서 사진 찍으러 오시는 분들도 꽤 많았습니다.
                                    영화를 좋아하신다면 방문해보기 좋은 코스로 추천드립니다!
                                </div>
                                <p class="mypage-date">2024.07.27</p>
                                <div class="mypage-star">
                                    5
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <div type="button" class="secessionBtn member whiteBtn">회원탈퇴</div>
                </div>
            </div>
        </div>
        <div class="tab-pane fade" id="profile-tab-pane" role="tabpanel" aria-labelledby="nav-profile-tab" tabindex="0">
            <div class="mypage-bottom-box">
                <div class="row">
                    <div class="col rev-inner-item">
                        <div class="rev-img">
                            <img src="/images/mypage/image1.jpg" alt="이미지">
                        </div>
                        <div class="rev-content">
                            <div class="mb-2 mt-4">겨울 호기심 천국 1박2일 체험 코스</div>
                            <button type="button" class="btn btn-primary btn-sm">바로가기</button>
                            <button type="button" class="btn btn-secondary btn-sm">찜하기 취소</button>
                        </div>
                    </div>
                    <div class="col rev-inner-item">
                        <div class="rev-img">
                            <img src="/images/mypage/image1.jpg" alt="이미지">
                        </div>
                        <div class="rev-content">
                            <div class="mb-2 mt-4">겨울 호기심 천국 1박2일 체험 코스</div>
                            <button type="button" class="btn btn-primary btn-sm">바로가기</button>
                            <button type="button" class="btn btn-secondary btn-sm">찜하기 취소</button>
                        </div>
                    </div>
                    <div class="col rev-inner-item">
                        <div class="rev-img">
                            <img src="/images/mypage/image1.jpg" alt="이미지">
                        </div>
                        <div class="rev-content">
                            <div class="mb-2 mt-4">겨울 호기심 천국 1박2일 체험 코스</div>
                            <button type="button" class="btn btn-primary btn-sm">바로가기</button>
                            <button type="button" class="btn btn-secondary btn-sm">찜하기 취소</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!--회원 수정 팝업-->
    <div class="profileModal modal">
        <div class="modal-dialog">
            <div class="modal-content p-5">
                <h2 class="text-center">회원정보 관리</h2>
                <hr>
                <form th:action="@{/mypage/modify}" method="POST" id="modifyForm">
                    <input type="hidden" name="userId" th:value="${member.userId}">
                    <div class="mb-2">
                        <label for="inputName" class="col-form-label">닉네임</label>
                        <input type="text" id="inputName" name="name" th:value="${member.name}">
                    </div>
                    <div class="mb-2">
                        <label for="inputEmail" class="col-form-label">이메일</label>
                        <input type="email" id="inputEmail" name="email" th:value="${member.email}">
                    </div>
                    <div class="mb-2">
                        <label for="inputAddress" class="col-form-label">주소</label>
                        <input type="text" id="inputAddress" name="address" th:value="${member.address}">
                    </div>
                    <div class="mb-2">
                        <label for="inputprofileText" class="col-form-label">소개말</label>
                        <input type="text" id="inputprofileText" name="profileText" th:value="${member.profileText}">
                    </div>
                    <div class="mb-2">
                        <label for="inputPassword" class="col-form-label">비밀번호 확인(필수)</label>
                        <input type="password" id="inputPassword" name="password">
                    </div>

                    <!-- 오류 메시지 표시 -->
                    <div id="modify-error"></div>

                    <div class="row align-items-end mt-5 mb-4">
                        <div class="col">
                            <button type="button" class="closeBtn btn btn-danger w-100">취소하기</button>
                        </div>
                        <div class="col">
                            <button type="submit" class="modBtn btn btn-primary w-100">회원정보 변경</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--회원 탈퇴 팝업-->
    <div class="secessionModal modal">
        <div class="modal-dialog">
            <div class="modal-content p-5">
                <h2 class="text-center">회원탈퇴</h2>
                <hr>
                <form th:action="@{/mypage/delete}" method="POST" id="deleteForm">
                    <input type="hidden" name="userId" th:value="${member.userId}">
                    <input type="hidden" name="address" th:value="${member.address}">
                    <input type="hidden" name="email" th:value="${member.email}">
                    <input type="hidden" name="name" th:value="${member.name}">
                    <div class="mb-4">회원 탈퇴하시겠습니까?<br> 탈퇴 시 삭제된 계정은 복구가 불가능합니다.</div>
                    <div class="mb-2">
                        <label for="password" class="col-form-label">비밀번호 확인</label>
                        <input type="text" id="password" name="password">
                    </div>
                    <!-- 오류 메시지 표시 -->
                    <div id="delete-error"></div>
                    <div class="row align-items-end mt-5 mb-4">
                        <div class="col">
                            <button type="button" class="secCloseBtn btn btn-danger w-100">취소하기</button>
                        </div>
                        <div class="col">
                            <button type="submit" class="secBtn btn btn-primary w-100">확인하기</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    <!--/회원 탈퇴 팝업-->
    <!-- 2. 첨부파일 추가를 위한 모달창 -->
    <div class="uploadModal modal">
        <div class="modal-dialog">
            <div class="modal-content">
                <form th:action="@{/profile/upload}" method="POST" id="myPageForm" enctype="multipart/form-data">
                    <div class="modal-header">
                        <h1 class="modal-title fs-5">프로필 변경</h1>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <!--프로필 이미지-->
                    <diV class="modal-body">
                        <div class="mb-3 row">
                            <div class="col">
                                <input type="file" class="form-control" id="uploadImgFile" name="uploadImgFile" multiple="">
                            </div>
                        </div>
                    </div>
                    <!-- 오류 메시지 표시 -->
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary addFilesCloseBtn" data-bs-dismiss="modal">닫기</button>
                        <button type="submit" class="btn btn-primary addFilesBtn" onclick="uploadFile();">업로드</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script layout:fragment="myscript" th:inline="javascript">
        //---------------------------프로필 이미지---------------------------//
        function uploadFile() {
            event.preventDefault(); //기본 동작 방지

            var uploadImgFile = $("#uploadImgFile").val(); //값 들고오기
            if(uploadImgFile != null) { //파일 존재시
                var ext = uploadImgFile.split('.').pop().toLowerCase(); //확장자 분리 및 소문자 변환
                if($.inArray(ext, ['jpg','jpeg','gif','png']) == -1) { //확장자가 배열에 존재하는데 확인
                  alert('이미지 파일만 업로드 할수 있습니다.');
                  return;
                }
            }
            document.forms['myPageForm'].submit(); //폼 제출
        }


        document.addEventListener('DOMContentLoaded', function() {
            const profileModal = new bootstrap.Modal(document.querySelector('.profileModal'));
            const secessionModal = new bootstrap.Modal(document.querySelector('.secessionModal'));
            const uploadModal = new bootstrap.Modal(document.querySelector(".uploadModal"));

            const modifyForm = document.querySelector('#modifyForm');
            const deleteForm = document.querySelector('#deleteForm');
            const inputPassword = document.querySelector("#inputPassword");

            // 프로필
            document.querySelector(".addFilesBtn").addEventListener('click', function(e) {
               console.log("test");
               uploadModal.show();
            });
            document.querySelector(".addFilesCloseBtn").addEventListener('click', function(e) {
               uploadModal.hide();
            });

            // 탈퇴
            document.querySelector(".secessionBtn").addEventListener('click', function(e) {
               console.log("test");
               secessionModal.show();
            });
            document.querySelector(".secCloseBtn").addEventListener('click', function(e) {
               secessionModal.hide();
            });

            // 열기
            document.querySelector('.profileBtn').addEventListener('click', function(e) {
                console.log("test");
               profileModal.show();
            });
            // 닫기
            document.querySelector('.closeBtn').addEventListener('click', function(e) {
               profileModal.hide();
            });

            // 수정
            document.querySelector('.modBtn').addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();

                console.log("test 시작");

                fetch('/mypage/check', {
                   method: 'POST',
                   body: new FormData(modifyForm)
                }).then(response => {
                   console.log("response received");

                   if (response.ok) {
                       return response.text(); // 응답 텍스트를 반환
                   } else {
                       throw new Error("서버 응답에 문제가 있습니다.");
                   }
                }).then(responsetext => {
                   console.log("responsetext:", responsetext);

                   const modifyError = document.querySelector('#modify-error');

                   if (responsetext.length != 0) {
                       modifyError.innerHTML = `<div class="alert alert-danger">${responsetext}</div>`
                   }

                   // 여기서 errorMessage의 값을 확인하고 후속 로직을 실행할 수 있습니다.
                   if (responsetext.length === 0) {
                       //console.log("submit")
                       // 유효성 검사에 문제가 없을 경우 폼을 제출
                       modifyForm.submit();
                   }

                   }).catch(error => {
                       console.error("Error: ", error);
                    });
                });
            });



            document.querySelector(".secBtn").addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();

            console.log("test 시작");
            fetch('/mypage/check', {
               method: 'POST',
               body: new FormData(deleteForm)

            }).then(response => {
               console.log("response received");

               if (response.ok) {
                   return response.text(); // 응답 텍스트를 반환
               } else {
                   throw new Error("서버 응답에 문제가 있습니다.");
               }
            }).then(responsetext => {
               console.log("responsetext:", responsetext);

               const deleteError = document.querySelector('#delete-error');

               if (responsetext.length != 0) {
                   deleteError.innerHTML = `<div class="alert alert-danger">${responsetext}</div>`
               }

               // 여기서 errorMessage의 값을 확인하고 후속 로직을 실행할 수 있습니다.
               if (responsetext.length === 0) {
                   //console.log("submit")
                   // 유효성 검사에 문제가 없을 경우 폼을 제출
                   deleteForm.submit();
               }

           }).catch(error => {
               console.error("Error: ", error);
           });
        });
    </script>
</div>
</body>
</html>